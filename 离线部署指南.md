# Langflow 开发环境运行机制与离线部署指南

## 一、`make init` 运行机制详解

### 1.1 执行流程

`make init` 命令会按以下顺序执行：

```83:87:Makefile
init: check_tools ## initialize the project
	@make install_backend
	@make install_frontend
	@uvx pre-commit install
	@echo "$(GREEN)All requirements are installed.$(NC)"
```

#### 步骤 1: 检查工具 (`check_tools`)
- 检查 `uv` 是否已安装（Python 包管理器）
- 检查 `npm` 是否已安装（Node.js 包管理器）

#### 步骤 2: 安装后端依赖 (`install_backend`)
```77:79:Makefile
install_backend: ## install the backend dependencies
	@echo 'Installing backend dependencies'
	@uv sync --frozen --extra "postgresql" $(EXTRA_ARGS)
```

**作用：**
- 使用 `uv sync` 命令同步 Python 依赖
- `--frozen` 参数：严格按照 `uv.lock` 文件安装，不更新版本
- `--extra "postgresql"`：安装 PostgreSQL 相关额外依赖
- 自动创建并管理 Python 虚拟环境

#### 步骤 3: 安装前端依赖 (`install_frontend`)
```14:16:Makefile.frontend
install_frontend: ## install the frontend dependencies
	@echo 'Installing frontend dependencies'
	@cd $(FRONTEND_DIR) && npm install > /dev/null 2>&1
```

**作用：**
- 在 `src/frontend` 目录执行 `npm install`
- 根据 `package.json` 和 `package-lock.json` 安装 Node.js 依赖

#### 步骤 4: 安装 pre-commit hooks
- 使用 `uvx pre-commit install` 安装 Git 提交前检查工具

---

## 二、环境安装位置

### 2.1 Python 虚拟环境（uv 管理）

**主要位置：**
- **虚拟环境目录**：`<项目根目录>/.venv/`
  - 包含所有已安装的 Python 包
  - 包含 Python 解释器链接
  - 包含可执行脚本（bin/ 目录）
  - **典型大小**：约 9-10 GB（包含所有依赖）

**uv 工具和 Python 解释器：**
- **uv 可执行文件**：`~/.local/bin/uv` 或系统 PATH 中的位置
- **Python 解释器缓存**：`~/.local/share/uv/python/`
  - uv 会在这里缓存下载的 Python 版本
  - 例如：`/root/.local/share/uv/python/cpython-3.13.9-linux-x86_64-gnu/`

**依赖锁定文件：**
- **主项目**：`uv.lock`（项目根目录）
- **langflow-base 子项目**：`src/backend/base/uv.lock`
- **依赖定义**：`pyproject.toml`（项目根目录）

### 2.2 Node.js 前端环境（npm 管理）

**主要位置：**
- **node_modules 目录**：`src/frontend/node_modules/`
  - 包含所有前端依赖包
  - **典型大小**：约 500 MB - 1 GB

**依赖锁定文件：**
- `src/frontend/package.json`：依赖定义
- `src/frontend/package-lock.json`：版本锁定文件

### 2.3 环境总结

| 环境类型 | 管理工具 | 安装位置 | 锁定文件 | 大小 |
|---------|---------|---------|---------|------|
| Python 后端 | uv | `.venv/` | `uv.lock`, `src/backend/base/uv.lock` | ~9-10 GB |
| Node.js 前端 | npm | `src/frontend/node_modules/` | `package-lock.json` | ~500 MB - 1 GB |
| Python 解释器 | uv | `~/.local/share/uv/python/` | - | ~100-200 MB |

---

## 三、离线服务器部署方案

### 方案 1: 完整环境打包（推荐用于完全离线环境）

#### 3.1.1 在源服务器上打包

```bash
# 1. 进入项目目录
cd /mnt/d/HonorStoreDownload/WSL/code/langflow/langflow

# 2. 创建打包目录
mkdir -p langflow-offline-package
cd langflow-offline-package

# 3. 打包 Python 虚拟环境（排除不必要的文件）
tar -czf langflow-venv.tar.gz \
    -C .. \
    --exclude='.venv/__pycache__' \
    --exclude='.venv/lib/python*/test' \
    --exclude='.venv/lib/python*/distutils' \
    .venv

# 4. 打包前端 node_modules
tar -czf langflow-node_modules.tar.gz \
    -C ../src/frontend \
    node_modules

# 5. 打包项目源代码（排除已打包的目录）
tar -czf langflow-source.tar.gz \
    -C .. \
    --exclude='.venv' \
    --exclude='src/frontend/node_modules' \
    --exclude='.git' \
    --exclude='__pycache__' \
    --exclude='*.pyc' \
    --exclude='.pytest_cache' \
    --exclude='test-results' \
    .

# 6. 打包 uv Python 解释器（如果需要）
tar -czf uv-python.tar.gz \
    -C ~/.local/share/uv \
    python

# 7. 创建部署脚本
cat > deploy.sh << 'EOF'
#!/bin/bash
# Langflow 离线部署脚本

set -e

PROJECT_DIR="/opt/langflow"
VENV_DIR="$PROJECT_DIR/.venv"
FRONTEND_DIR="$PROJECT_DIR/src/frontend"

echo "开始部署 Langflow..."

# 解压源代码
echo "解压源代码..."
tar -xzf langflow-source.tar.gz -C "$PROJECT_DIR"

# 解压虚拟环境
echo "解压 Python 虚拟环境..."
mkdir -p "$VENV_DIR"
tar -xzf langflow-venv.tar.gz -C "$PROJECT_DIR"

# 解压前端依赖
echo "解压前端依赖..."
mkdir -p "$FRONTEND_DIR"
tar -xzf langflow-node_modules.tar.gz -C "$FRONTEND_DIR"

# 解压 Python 解释器（如果需要）
if [ -f "uv-python.tar.gz" ]; then
    echo "解压 Python 解释器..."
    mkdir -p ~/.local/share/uv
    tar -xzf uv-python.tar.gz -C ~/.local/share/uv
fi

# 修复虚拟环境中的路径（重要！）
echo "修复虚拟环境路径..."
cd "$VENV_DIR"
OLD_PATH=$(grep -h "^#!" bin/* 2>/dev/null | head -1 | sed 's/#!//' | tr -d ' ')
if [ -n "$OLD_PATH" ]; then
    NEW_PATH="$VENV_DIR/bin/python"
    find bin -type f -exec sed -i "s|$OLD_PATH|$NEW_PATH|g" {} \;
fi

# 设置权限
chmod +x "$VENV_DIR/bin"/*

echo "部署完成！"
echo "虚拟环境位置: $VENV_DIR"
echo "前端依赖位置: $FRONTEND_DIR/node_modules"
EOF

chmod +x deploy.sh

# 8. 创建 README
cat > README.md << 'EOF'
# Langflow 离线部署包

## 文件说明
- `langflow-source.tar.gz`: 项目源代码
- `langflow-venv.tar.gz`: Python 虚拟环境（包含所有依赖）
- `langflow-node_modules.tar.gz`: 前端 Node.js 依赖
- `uv-python.tar.gz`: uv Python 解释器（可选）
- `deploy.sh`: 自动部署脚本

## 部署步骤
1. 将整个目录传输到目标服务器
2. 在目标服务器上执行: `bash deploy.sh`
3. 确保目标服务器有相同架构（x86_64/arm64）和操作系统（Linux）

## 注意事项
- 目标服务器需要安装 uv 和 npm（或使用打包的版本）
- 确保 Python 版本兼容（3.10-3.13）
- 如果架构不同，需要重新编译部分包
EOF

# 9. 创建完整打包脚本
cat > package-all.sh << 'EOF'
#!/bin/bash
# 完整打包脚本

VERSION=$(date +%Y%m%d-%H%M%S)
PACKAGE_NAME="langflow-offline-${VERSION}"

mkdir -p "$PACKAGE_NAME"
cd "$PACKAGE_NAME"

# 执行上述打包步骤
# ... (将上面的命令整合)

echo "打包完成: $PACKAGE_NAME"
du -sh .
EOF

chmod +x package-all.sh
```

#### 3.1.2 在目标服务器上部署

```bash
# 1. 传输打包文件到目标服务器
# 使用 scp, rsync 或其他方式

# 2. 在目标服务器上解压和部署
cd /path/to/package
bash deploy.sh

# 3. 验证安装
cd /opt/langflow
source .venv/bin/activate
uv run langflow --version

# 4. 运行 Langflow
uv run langflow run
```

---

### 方案 2: 使用 uv 离线模式（推荐，更灵活）

#### 3.2.1 在源服务器上准备离线包

```bash
# 1. 导出所有依赖包到本地目录
mkdir -p offline-packages
cd offline-packages

# 2. 使用 uv 导出 wheel 文件
cd /mnt/d/HonorStoreDownload/WSL/code/langflow/langflow
uv pip compile pyproject.toml -o requirements.txt

# 3. 下载所有依赖到本地（不安装）
uv pip download -r requirements.txt -d offline-packages/wheels

# 4. 或者使用 uv 的离线模式
uv sync --offline --frozen --extra "postgresql"
```

#### 3.2.2 创建离线安装脚本

```bash
cat > install-offline.sh << 'EOF'
#!/bin/bash
# 离线安装脚本

set -e

WHEELS_DIR="offline-packages/wheels"
PROJECT_DIR="/opt/langflow"

echo "开始离线安装..."

# 1. 安装 uv（如果未安装）
if ! command -v uv &> /dev/null; then
    echo "安装 uv..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    export PATH="$HOME/.cargo/bin:$PATH"
fi

# 2. 创建项目目录
mkdir -p "$PROJECT_DIR"
cd "$PROJECT_DIR"

# 3. 复制源代码
# (假设源代码已传输)

# 4. 使用本地 wheel 文件安装依赖
uv sync --frozen --extra "postgresql" \
    --find-links "$WHEELS_DIR" \
    --no-index

# 5. 安装前端依赖（需要先传输 node_modules 或使用 npm）
cd src/frontend
npm install --offline --prefer-offline

echo "安装完成！"
EOF
```

---

### 方案 3: Docker 容器化部署（最推荐）

#### 3.3.1 构建 Docker 镜像

```bash
# 使用项目自带的 Dockerfile
cd /mnt/d/HonorStoreDownload/WSL/code/langflow/langflow
make docker_build

# 或者手动构建
docker build -f docker/build_and_push.Dockerfile -t langflow:offline .
```

#### 3.3.2 导出和导入镜像

```bash
# 在源服务器上导出镜像
docker save langflow:offline | gzip > langflow-offline-image.tar.gz

# 在目标服务器上导入镜像
gunzip -c langflow-offline-image.tar.gz | docker load

# 运行容器
docker run -d \
    -p 7860:7860 \
    -v langflow-data:/app/data \
    langflow:offline
```

---

## 四、部署检查清单

### 4.1 环境要求

- [ ] 操作系统：Linux（与源服务器相同或兼容）
- [ ] 架构：x86_64 或 arm64（必须匹配）
- [ ] Python 版本：3.10 - 3.13（如果使用系统 Python）
- [ ] Node.js 版本：18.x 或更高（如果重新安装前端依赖）
- [ ] 磁盘空间：至少 15-20 GB 可用空间

### 4.2 必需工具

- [ ] `uv`：Python 包管理器
- [ ] `npm` 或 `node`：Node.js 包管理器
- [ ] `tar` 和 `gzip`：解压工具
- [ ] `bash`：脚本执行环境

### 4.3 验证步骤

```bash
# 1. 检查虚拟环境
ls -la .venv/bin/python*
.venv/bin/python --version

# 2. 检查已安装的包
.venv/bin/pip list | head -20

# 3. 检查前端依赖
ls -la src/frontend/node_modules | head -10

# 4. 测试运行
source .venv/bin/activate
uv run langflow --help
```

---

## 五、常见问题与解决方案

### 5.1 虚拟环境路径问题

**问题**：虚拟环境中的脚本包含硬编码的绝对路径

**解决**：
```bash
# 使用 virtualenv 的 relocatable 选项（如果使用 virtualenv）
# 或手动修复路径
find .venv/bin -type f -exec sed -i "s|/old/path|/new/path|g" {} \;
```

### 5.2 架构不匹配

**问题**：源服务器和目标服务器架构不同（x86_64 vs arm64）

**解决**：
- 方案 A：在目标服务器上重新安装依赖
- 方案 B：使用 Docker 多架构镜像
- 方案 C：只打包源代码，在目标服务器上运行 `make init`

### 5.3 依赖版本冲突

**问题**：目标服务器已有其他 Python 环境

**解决**：
- 使用独立的虚拟环境（`.venv`）
- 确保使用 `--frozen` 参数锁定版本
- 检查 `uv.lock` 文件是否完整传输

### 5.4 前端构建问题

**问题**：前端需要重新构建

**解决**：
```bash
# 在目标服务器上重新构建前端
cd src/frontend
npm install
npm run build

# 或使用已构建的文件
cp -r src/frontend/build src/backend/base/langflow/frontend
```

---

## 六、最佳实践建议

1. **优先使用 Docker**：容器化部署最简单、最可靠
2. **保留锁定文件**：确保 `uv.lock` 和 `package-lock.json` 完整
3. **测试部署**：先在测试环境验证部署流程
4. **文档化**：记录源服务器和目标服务器的环境信息
5. **版本控制**：为每次部署创建版本标签

---

## 七、快速参考命令

```bash
# 查看虚拟环境位置
ls -la .venv

# 查看虚拟环境大小
du -sh .venv

# 查看已安装的 Python 包
.venv/bin/pip list

# 查看 uv 管理的 Python 版本
uv python list

# 查看前端依赖
cd src/frontend && npm list --depth=0

# 重新同步依赖（如果锁定文件存在）
uv sync --frozen

# 导出依赖列表
uv pip freeze > requirements-export.txt
```

---

**最后更新**：2024年12月








